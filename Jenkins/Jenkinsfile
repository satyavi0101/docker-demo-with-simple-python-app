pipeline {
  agent any
  environment {
    AWS_REGION = 'us-east-1'
    APP_NAME = 'my-web-app'
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/your-user/your-repo.git'
      }
    }

    stage('Terraform Init & Apply') {
      steps {
        dir('infrastructure') {
          sh 'terraform init'
          sh 'terraform apply -auto-approve'
          script {
            env.ECR_REPO = sh(script: "terraform output -raw ecr_repository_url", returnStdout: true).trim()
            echo "ECR Repo URL: ${env.ECR_REPO}"
          }
        }
      }
    }

    stage('Build and Push Docker Image') {
      steps {
        dir('your-app-folder') {  // adjust this folder if needed
          script {
            docker.withRegistry("https://${env.ECR_REPO}", 'aws-ecr-creds-id') {
              def image = docker.build("${env.ECR_REPO}:latest")
              image.push()
            }
          }
        }
      }
    }

    stage('Deploy ECS Service') {
      steps {
        dir('infrastructure') {
          sh 'terraform apply -auto-approve'
        }
      }
    }
  }
}
